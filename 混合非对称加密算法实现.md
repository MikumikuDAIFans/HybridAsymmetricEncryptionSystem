# 混合加密云端同步架构深度技术报告：全流程详解与实现方案

## 1. 执行摘要与架构宏观愿景

本报告旨在为一套高安全性、混合架构的云端与本地文件同步系统提供详尽的实施蓝图。该系统专为满足**“云端明文存储，下云安全分发”**的特定场景需求而设计。通过结合非对称加密（RSA）与对称加密（AES-GCM）的优势，构建了一个“反向信封加密”（Reverse Envelope Encryption）模型。

本方案的独特之处在于其交付形态：
1.  **云端服务端（Docker）**：作为数据中心，负责接收原始数据，并在分发时实时进行动态加密。支持密钥生命周期管理。
2.  **本地客户端（Client/WebUI）**：持有解密私钥，负责上传原始数据及下载并解密敏感数据。

---

## 2. 核心设计理念：安全下云分发

传统的加密方案通常侧重于“上云加密”，即数据离开本地前即被加密。本架构针对特定合规或业务需求（如云端需要进行明文数据分析，但分发给终端用户时需加密），实施了**“安全下云”**策略：

1.  **上传（明文通道）：** 客户端通过安全通道（HTTPS推荐，模拟环境为HTTP）将原始文件流式上传至云端。云端以明文形式存储文件。
2.  **下载（实时加密）：** 当用户请求下载时，服务端读取磁盘上的明文文件，利用用户的**公钥**（Public Key）和随机生成的**会话密钥**（DEK），实时生成加密数据流。
3.  **解密（本地私钥）：** 客户端接收到加密流后，利用本地存储的**私钥**（Private Key）解密会话密钥，进而解密文件内容。
4.  **密钥轮换（Key Rotation）：** 当用户怀疑私钥泄露时，可主动请求服务端生成新的 RSA 密钥对。服务端立即更新公钥，并将新私钥一次性安全传输给用户，旧密钥即刻失效（针对新下载）。

这种架构确保了：即使传输链路被窃听，攻击者截获的也只是密文；即使用户下载了文件，若无私钥也无法查看内容；即使私钥泄露，也能通过轮换机制止损。

---

## 3. 密码学原语与协议规范

### 3.1 算法选择
*   **对称加密（数据层）：** AES-256-GCM。选用 GCM 模式因其提供了机密性与完整性校验（Auth Tag），防止密文被篡改。
*   **非对称加密（密钥层）：** RSA-4096 (OAEP Padding, SHA-256)。用于加密 32 字节的 AES DEK。

### 3.2 HENC 二进制信封协议
系统定义了自定义的二进制协议（HENC）用于传输加密数据。服务端在发送数据时，会动态封装此协议头。

| 偏移量 | 字段 | 长度 | 描述 |
| :--- | :--- | :--- | :--- |
| 0x00 | **Magic** | 4 Bytes | 固定值 `HENC` |
| 0x04 | **Version** | 1 Byte | 协议版本 (0x01) |
| 0x05 | **Algo** | 1 Byte | 算法标识 (0x01 = AES-GCM) |
| 0x06 | **Block Size** | 4 Bytes | 分块大小 (Big-Endian, 默认 64KB) |
| 0x0A | **Base IV** | 12 Bytes | 基础初始化向量 |
| 0x16 | **Enc DEK Len** | 2 Bytes | 加密后的 DEK 长度 |
| 0x18 | **Enc DEK** | Var | RSA 加密的 AES 会话密钥 |
| Var | **Payload** | Stream | 连续的密文块序列 |

**Payload 结构：**
每个数据块由 `[Ciphertext (Block Size)] + [Auth Tag (16 Bytes)]` 组成。这种**分块 AEAD** 策略允许流式解密和实时完整性校验，无需缓冲整个文件。

---

## 4. 系统组件实现详解

### 4.1 云端服务端 (Server)
*   **技术栈**：Python 3.11, FastAPI, Docker (Alpine Linux)
*   **密钥管理**：
    *   服务端持有用户的**公钥 (Public Key)**，存储于 SQLite 数据库。
    *   提供 `/rotate-keys` 接口，支持在线生成新密钥对并更新数据库记录。
*   **核心逻辑**：
    *   `/upload`：接收 `multipart/form-data` 或二进制流，直接写入磁盘。
    *   `/download`：读取文件 -> 生成 DEK -> RSA 加密 DEK -> 构造 HENC 头 -> 循环读取文件块 -> AES-GCM 加密 -> `yield` 数据流。
*   **Docker 优化**：使用多阶段构建（Multi-Stage Build）解决 `cryptography` 库在 Alpine 下的编译依赖问题，镜像体积控制在 100MB 左右。

### 4.2 本地客户端 (Client & WebUI)
本项目提供两种客户端形态：

#### 4.2.1 命令行客户端 (CLI)
*   **功能**：提供脚本化的上传与下载能力。
*   **实现**：
    *   `upload`：发送标准 HTTP POST 请求。
    *   `download`：请求下载接口，解析 HENC 协议流，调用 `decryption_engine` 实时解密写入磁盘。
*   **打包**：使用 PyInstaller 编译为单文件 EXE，内置 `private.pem` 私钥资源。

#### 4.2.2 Web 可视化界面 (WebUI)
*   **技术栈**：Streamlit
*   **功能**：
    *   **Server Module**：查看云端文件列表，触发云端加密下载。
    *   **Local Module**：扫描下载目录的 `.enc` 文件，使用本地私钥解密，并调用系统资源管理器打开。
    *   **Key Management**：一键请求密钥轮换，自动备份旧私钥并应用新私钥。
    *   **一键操作**：提供友好的图形化操作流程。

---

## 5. 安全性分析

### 5.1 威胁模型
*   **传输窃听**：攻击者在下载过程中截获数据包。
    *   *缓解*：数据流本身已通过 RSA+AES 混合加密，无私钥无法解密。
*   **云端泄露**：云存储被攻破。
    *   *风险*：由于需求定义为“云上原始数据”，云端存储的是明文。这符合特定业务需求（如云端审计），但需依赖云端自身的访问控制（ACL）进行保护。
*   **私钥泄露**：用户电脑被入侵。
    *   *风险*：攻击者可解密该用户下载的所有历史文件。
    *   *缓解*：私钥文件权限应受控。用户可通过 WebUI 的 **Key Management** 立即轮换密钥，使泄露的旧私钥失效（针对未来下载）。

### 5.2 性能考量
*   **流式处理**：无论是加密还是解密，内存占用均为 O(1)，仅取决于块大小（64KB），支持 GB 级大文件传输。
*   **AES-NI 指令集**：利用 CPU 硬件加速 AES 运算，确保加密过程不成为传输瓶颈。

---

## 6. 部署与模拟

系统包含自动化脚本 `build_simulation.bat`，可在 Windows 环境下通过 Docker Desktop 一键构建完整的模拟环境：
1.  生成 RSA 密钥对（Public -> Server, Private -> Client）。
2.  构建服务端 Docker 镜像并运行。
3.  构建客户端 EXE。
4.  安装并启动 WebUI。

通过此环境，开发者可直观验证“上传明文 -> 存储明文 -> 下载加密 -> 本地解密”的完整数据生命周期。
